format where (

to_string = #"to_string.cru",
arith = #"arith.cru",
logic = #"logic.cru",
tuple = #"tuple.cru",

add = arith.add,
eq = arith.eq,
if = logic.if,

format s a =
  if (tuple.empty s) "" $
  let first = tuple.head s in
  if (eq first "%") (
    add (to_string (tuple.head a)) (format (tuple.tail s) (tuple.tail a))) $
  add first (format (tuple.tail s) a))